name: CD - Deploy with Evidence

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Instalar kubectl
      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      # 3. Guardar kubeconfig
      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      # 4. Desplegar
      - name: Apply manifests
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/api-deployment --timeout=120s

      # 5. Obtener pod
      - name: Get API pod
        id: pod
        run: |
          POD=$(kubectl get pods -l app=api -o jsonpath='{.items[0].metadata.name}')
          echo "pod_name=$POD" >> $GITHUB_OUTPUT
          echo "API Pod: $POD"

      # 6. Port-forward y ngrok
      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install -y ngrok

      - name: Start port-forward + ngrok
        run: |
          kubectl port-forward pod/${{ steps.pod.outputs.pod_name }} 5000:5000 >/dev/null 2>&1 &
          sleep 4
          nohup ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
          sleep 6

          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Public URL: $URL"

      # 7. Probar API real desplegada
      - name: Test Public API
        id: apitest
        run: |
          RESPONSE=$(curl -s ${{ steps.start_ngrok.outputs.ngrok_url }})
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "API Response: $RESPONSE"

      # 8. Crear reporte PDF
      - name: Install pandoc
        run: sudo apt-get install -y pandoc

      - name: Generate Deployment Evidence PDF
        run: |
          cat <<EOF > evidence.md
          # ðŸš€ Evidencia de Despliegue en Kubernetes

          ## ðŸ“Œ 1. Pod desplegado
          **Pod:** ${{ steps.pod.outputs.pod_name }}

          ## ðŸ“Œ 2. Manifiestos aplicados
          Archivos del directorio \`k8s/\` se aplicaron correctamente.

          ## ðŸ“Œ 3. URL pÃºblica generada (ngrok)
          **${{ steps.start_ngrok.outputs.ngrok_url }}**

          ## ðŸ“Œ 4. Respuesta real de la API
          \`\`\`json
          ${{ steps.apitest.outputs.response }}
          \`\`\`

          ## ðŸ“Œ 5. Logs del pod
          \`\`\`
          $(kubectl logs ${{ steps.pod.outputs.pod_name }})
          \`\`\`

          ## ðŸ“Œ 6. Estado de pods
          \`\`\`
          $(kubectl get pods -o wide)
          \`\`\`

          ## ðŸ“Œ 7. Servicios activos
          \`\`\`
          $(kubectl get svc -o wide)
          \`\`\`
          EOF

          pandoc evidence.md -o evidence.pdf

      # 9. Guardar reporte como artefacto
      - name: Upload Evidence
        uses: actions/upload-artifact@v4
        with:
          name: deployment-evidence
          path: evidence.pdf
