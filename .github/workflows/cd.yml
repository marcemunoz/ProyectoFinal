name: CD - Deploy to Minikube

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # --- Instalar Minikube ---
    - name: Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube

    # --- Iniciar cluster ---
    - name: Start Minikube
      run: |
        minikube start --driver=docker
        kubectl get nodes

    # --- Aplicar deployment y service ---
    - name: Deploy API
      run: |
        kubectl apply -f k8s/api-deployment.yaml
        kubectl apply -f k8s/api-service.yaml

    # --- Esperar a que los pods arranquen ---
    - name: Wait for Deployment
      run: |
        kubectl wait --for=condition=available deployment/api-deployment --timeout=60s

    # --- Guardar estado del despliegue ---
    - name: Save Kubernetes State
      run: |
        echo "==== PODS ====" > k8s_state.txt
        kubectl get pods >> k8s_state.txt
        echo "==== SERVICES ====" >> k8s_state.txt
        kubectl get svc >> k8s_state.txt

    # --- Test interno desde dentro del cluster ---
    - name: Internal API Test
      run: |
        POD=$(kubectl get pod -l app=api -o jsonpath='{.items[0].metadata.name}')
        kubectl exec $POD -- curl -s http://localhost:3000 > api_response.txt || echo "API not responding"

    # --- Subir artefactos como evidencia ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: evidencias_cd
        path: |
          k8s_state.txt
          api_response.txt
